{"version":3,"file":"element.min.js","sources":["../../../../src/app/block/item/element.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_strings} from \"core/str\";\nimport Ajax from \"core/ajax\";\n\nexport default class ItemElement {\n    /**\n     * @type {BaseFactory}\n     */\n    #baseFactory;\n\n    /**\n     * @type {BlockElement}\n     */\n    #blockElement;\n\n    /**\n     * @type {HTMLElement}\n     */\n    #element;\n\n    constructor(baseFactory, blockElement, element) {\n        this.#baseFactory = baseFactory;\n        this.#blockElement = blockElement;\n        this.#element = element;\n\n        if (this.#element.dataset.status === '0') {\n            this.#pollItem();\n        }\n\n        this.#addEventListeners();\n    }\n\n    #pollItem(currentTry = 0, retries = 10) {\n        currentTry += 1;\n\n        if (currentTry >= retries) {\n            console.error(\"Item not finished after \" + retries + \" retries, giving up.\");\n            return;\n        }\n\n        Ajax.call([{\n            methodname: 'block_sharing_cart_get_item_from_sharing_cart',\n            args: {\n                item_id: this.getItemId(),\n            },\n            done: async (item) => {\n                if (item.status === 0) {\n                    new Promise(\n                        (resolve) => {\n                            setTimeout(resolve, currentTry * 1000);\n                        }\n                    ).then(\n                        () => {\n                            this.#pollItem(currentTry, retries);\n                        }\n                    );\n\n                    return;\n                }\n\n                await this.#blockElement.renderItem(item);\n            },\n            fail: (data) => {\n                console.error(data);\n            }\n        }]);\n    }\n\n    #addEventListeners() {\n        this.#element.addEventListener('click', this.toggleCollapseRecursively.bind(this));\n\n        this.#element.querySelector('[data-action=\"delete\"]')?.addEventListener('click', this.confirmDeleteItem.bind(this));\n        this.#element.querySelector('[data-action=\"copy_to_course\"]')?.addEventListener('click', this.copyItemToCourse.bind(this));\n        this.#element.querySelector('[data-action=\"run_now\"]')?.addEventListener('click', this.runNow.bind(this));\n    }\n\n    async copyItemToCourse(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        await this.#blockElement.setClipboard(this);\n    }\n\n    async runNow(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const currentTarget = e.currentTarget;\n\n        Ajax.call([{\n            methodname: 'block_sharing_cart_run_task_now',\n            args: {\n                task_id: currentTarget?.dataset?.taskId ?? null,\n            },\n            done: async () => {\n                currentTarget.remove();\n                this.#pollItem();\n            },\n            fail: (data) => {\n                console.error(data);\n            }\n        }]);\n    }\n\n    async confirmDeleteItem(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const strings = await get_strings([\n            {\n                key: 'delete_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'confirm_delete_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'delete',\n                component: 'core',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.DELETE_CANCEL,\n            title: strings[0] + ': \"' + this.getItemName().slice(0, 50).trim() + '\"',\n            body: strings[1],\n            buttons: {\n                delete: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n        modal.getRoot().on(ModalEvents.delete, this.#blockElement.deleteItem.bind(this.#blockElement, this));\n        await modal.show();\n    }\n\n    /**\n     * @return {NodeListOf<HTMLElement>}\n     */\n    getItemChildrenRecursively() {\n        return this.#element.querySelectorAll('.sharing_cart_item');\n    }\n\n    /**\n     * @return {HTMLElement}\n     */\n    getItemElement() {\n        return this.#element;\n    }\n\n    /**\n     * @return {String}\n     */\n    getItemName() {\n        return this.#element.querySelector('.name').innerText;\n    }\n\n    /**\n     * @return {Number}\n     */\n    getItemId() {\n        return Number.parseInt(this.#element.dataset.itemid);\n    }\n\n    /**\n     * @return {HTMLElement}\n     */\n    getItemInfo() {\n        return this.#element.querySelector('.info');\n    }\n\n    /**\n     * @param {HTMLElement} item\n     * @param {Boolean|NULL} collapse\n     */\n    toggleCollapse(item, collapse = null) {\n        if (item.dataset.type !== 'section' &&\n            item.dataset.status !== '0' &&\n            item.dataset.status !== '2') {\n            return;\n        }\n\n        if (collapse !== null) {\n            item.dataset.collapsed = collapse ? 'true' : 'false';\n        } else {\n            item.dataset.collapsed = item.dataset.collapsed === 'true' ? 'false' : 'true';\n        }\n\n        const iconElement = item.querySelector('.info > i');\n        iconElement.classList.remove('fa-folder-o', 'fa-folder-open-o');\n        iconElement.classList.add(item.dataset.collapsed === 'true' ? 'fa-folder-o' : 'fa-folder-open-o');\n    }\n\n    isModule() {\n        return !this.isSection();\n    }\n\n    isSection() {\n        return this.#element.dataset.type === 'section';\n    }\n\n    /**\n     * @param {Event} e\n     */\n    toggleCollapseRecursively(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (this.isModule() || this.#element.dataset.status !== '1') {\n            return;\n        }\n\n        this.toggleCollapse(this.#element);\n        this.getItemChildrenRecursively().forEach((item) => {\n            this.toggleCollapse(item, this.#element.dataset.collapsed === 'true');\n        });\n    }\n\n    remove() {\n        this.#element.remove();\n    }\n}"],"names":["currentTry","retries","console","error","call","methodname","args","item_id","this","getItemId","done","async","item","status","_classPrivateFieldGet","renderItem","Promise","resolve","setTimeout","then","fail","data","addEventListener","toggleCollapseRecursively","bind","querySelector","confirmDeleteItem","copyItemToCourse","runNow","constructor","baseFactory","blockElement","element","dataset","e","preventDefault","stopPropagation","setClipboard","currentTarget","task_id","_currentTarget$datase2","taskId","remove","strings","key","component","modal","ModalFactory","create","type","types","DELETE_CANCEL","title","getItemName","slice","trim","body","buttons","delete","cancel","removeOnClose","getRoot","on","ModalEvents","deleteItem","show","getItemChildrenRecursively","querySelectorAll","getItemElement","innerText","Number","parseInt","itemid","getItemInfo","toggleCollapse","collapse","collapsed","iconElement","classList","add","isModule","isSection","forEach"],"mappings":"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"}