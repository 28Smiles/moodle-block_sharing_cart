{"version":3,"file":"element.min.js","sources":["../../../src/app/block/element.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string, get_strings} from \"core/str\";\nimport Ajax from \"core/ajax\";\n\nexport default class BlockElement {\n    /**\n     * @type {BaseFactory}\n     */\n    #baseFactory;\n\n    /**\n     * @type {HTMLElement}\n     */\n    #element;\n\n    /**\n     * @type {CourseElement}\n     */\n    #course;\n\n    /**\n     * @type {QueueElement}\n     */\n    #queue;\n\n    /**\n     * @type {ItemElement[]}\n     */\n    #items = [];\n\n    /**\n     * @type {ItemElement|NULL}\n     */\n    #clipboardItem = null;\n\n    #canBackupUserdata = false;\n    #canAnonymizeUserdata = false;\n\n    constructor(baseFactory, element, canBackupUserdata, canAnonymizeUserdata) {\n        this.#baseFactory = baseFactory;\n        this.#element = element;\n        this.#canBackupUserdata = canBackupUserdata;\n        this.#canAnonymizeUserdata = canAnonymizeUserdata;\n    }\n\n    addEventListeners() {\n        this.setupCourse();\n        this.setupQueue();\n        this.setupItems();\n    }\n\n    setupCourse() {\n        const course = document.querySelector('.course-content');\n\n        const courseElement = this.#baseFactory.block().course().element(this, course);\n        courseElement.addBackupToSharingCartButtons();\n\n        this.#course = courseElement;\n    }\n\n    setupQueue() {\n        const queue = document.querySelector('.sharing_cart_queue');\n\n        this.#queue = this.#baseFactory.block().queue().element(this, queue);\n    }\n\n    setupItems() {\n        const items = this.#element.querySelectorAll('.sharing_cart_item');\n\n        items.forEach((element) => {\n            this.setupItem(element);\n        });\n    }\n\n    /**\n     * @param {HTMLElement} element\n     */\n    setupItem(element) {\n        const itemElement = this.#baseFactory.block().item().element(this, element);\n\n        this.#element.querySelector('.no-items')?.remove();\n\n        this.#items.push(\n            itemElement\n        );\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async setClipboard(item) {\n        this.#clipboardItem = item;\n\n        await this.#course.setClipboard(item);\n    }\n\n    clearClipboard() {\n        this.#clipboardItem = null;\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    deleteItem(item) {\n        Ajax.call([{\n            methodname: 'block_sharing_cart_delete_item_from_sharing_cart',\n            args: {\n                item_id: item.getItemId(),\n            },\n            done: async (deleted) => {\n                if (deleted) {\n                    const childItems = item.getItemChildrenRecursively();\n                    childItems.forEach((childItem) => {\n                        const index = this.#items.findIndex((i) => i.getItemId() === Number.parseInt(childItem.dataset.itemid));\n                        if (index === -1) {\n                            return;\n                        }\n\n                        if (this.#items[index].getItemId() === this.#clipboardItem?.getItemId()) {\n                            this.#course.clearClipboard();\n                        }\n\n                        this.#items.splice(index, 1);\n                        childItem.remove();\n                    });\n\n                    const index = this.#items.findIndex((i) => i.getItemId() === item.getItemId());\n                    if (this.#items[index].getItemId() === this.#clipboardItem?.getItemId()) {\n                        this.#course.clearClipboard();\n                    }\n\n                    this.#items.splice(index, 1);\n                    item.remove();\n\n                    if (this.#items.length === 0) {\n                        this.#element.querySelector('.sharing_cart_items')\n                            .innerHTML = await get_string('no_items', 'block_sharing_cart');\n                    }\n                } else {\n                    console.error('Failed to delete item');\n                }\n            },\n            fail: (data) => {\n                console.error(data);\n            }\n        }]);\n    }\n\n    /**\n     * @param {String} itemName\n     * @param {CallableFunction} onSave\n     * @return {Promise<Modal>}\n     */\n    async createBackupItemToSharingCartModal(itemName, onSave) {\n        const strings = await get_strings([\n            {\n                key: 'backup_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'into_sharing_cart',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'backup',\n                component: 'core',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const {html, js} = await this.#baseFactory.moodle().template().renderTemplate(\n            'block_sharing_cart/modal/backup_to_sharing_cart_modal_body',\n            {\n                show_user_data_backup: this.#canBackupUserdata,\n                show_anonymize_user_data: this.#canBackupUserdata && this.#canAnonymizeUserdata,\n            }\n        );\n\n        /**\n         * @type {Modal}\n         */\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0] + ': \"' + itemName.slice(0, 50).trim() + '\" ' + strings[1],\n            body: html,\n            buttons: {\n                save: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n        modal.getRoot().on(ModalEvents.shown, () => this.#baseFactory.moodle().template().runTemplateJS(js));\n        modal.getRoot().on(ModalEvents.save, () => {\n            const modalUserdataCheckbox = document.getElementById('modal-userdata-checkbox');\n            const modalAnonymizeCheckbox = document.getElementById('modal-anonymize-checkbox');\n\n            onSave({\n                users: modalUserdataCheckbox.checked ?? false,\n                anonymize: modalAnonymizeCheckbox.checked ?? false\n            });\n        });\n\n        return modal;\n    }\n\n    /**\n     * @param {Number} sectionId\n     */\n    async addSectionBackupToSharingCart(sectionId) {\n        const sectionName = this.#course.getSectionName(sectionId);\n\n        const modal = await this.createBackupItemToSharingCartModal(sectionName, (settings) => {\n            Ajax.call([{\n                methodname: 'block_sharing_cart_backup_section_into_sharing_cart',\n                args: {\n                    section_id: sectionId,\n                    settings: settings\n                },\n                done: async (data) => {\n                    await this.renderItem(data);\n                },\n                fail: (data) => {\n                    console.error(data);\n                }\n            }]);\n        });\n\n        await modal.show();\n    }\n\n    /**\n     * @param {Number} courseModuleId\n     */\n    async addCourseModuleBackupToSharingCart(courseModuleId) {\n        const courseModuleName = this.#course.getCourseModuleName(courseModuleId);\n\n        const modal = await this.createBackupItemToSharingCartModal(courseModuleName, (settings) => {\n            Ajax.call([{\n                methodname: 'block_sharing_cart_backup_course_module_into_sharing_cart',\n                args: {\n                    course_module_id: courseModuleId,\n                    settings: settings\n                },\n                done: async (data) => {\n                    await this.renderItem(data);\n                },\n                fail: (data) => {\n                    console.error(data);\n                }\n            }]);\n        });\n        await modal.show();\n    }\n\n    /**\n     * @param {Object} item\n     */\n    async renderItem(item) {\n        const existingItemIndex = this.#items.findIndex((i) => i.getItemId() === item.id);\n        const existingItem = this.#items[existingItemIndex] ?? false;\n        const oldElement = this.#element.querySelector('.sharing_cart_items .sharing_cart_item[data-itemid=\"' + item.id + '\"]');\n        if (existingItem && oldElement) {\n            const element = await this.#baseFactory.moodle().template().createElementFromFragment(\n                'block_sharing_cart',\n                'item',\n                1,\n                {\n                    item_id: item.id,\n                }\n            );\n\n            this.#element.querySelector('.sharing_cart_items').replaceChild(element, oldElement);\n            this.#items[existingItemIndex] = this.#baseFactory.block().item().element(this, element);\n\n            element.querySelectorAll('.sharing_cart_item').forEach((subItem) => {\n                this.setupItem(subItem);\n            });\n\n            return;\n        }\n\n        const element = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/item',\n            {\n                id: item.id,\n                name: item.name,\n                type: item.type,\n                status: 0,\n                status_awaiting: true,\n                has_run_now: true,\n                task_id: item.task_id ?? null,\n                status_finished: false,\n                status_failed: false,\n                is_module: item.type !== 'section',\n                is_section: item.type === 'section',\n                is_root: true,\n            }\n        );\n        this.#element.querySelector('.sharing_cart_items').append(element);\n\n        this.setupItem(element);\n    }\n\n    /**\n     * @param {ItemElement} item\n     * @param {Number} sectionId\n     * @param {HTMLElement} modal\n     */\n    importItem(item, sectionId, modal) {\n        this.#course.clearClipboard();\n\n        const courseModuleIds = [];\n        modal.querySelectorAll('input[type=\"checkbox\"][data-type=\"coursemodule\"]:checked').forEach((checkbox) => {\n            courseModuleIds.push(checkbox.dataset.id);\n        });\n\n        if (item.isSection() && courseModuleIds.length === 0) {\n            modal.querySelectorAll('.form-check-input').forEach(async (item) => {\n                item.setCustomValidity(\n                    await get_string('atleast_one_course_module_must_be_included', 'block_sharing_cart')\n                );\n                item.reportValidity();\n            });\n            return false;\n        }\n\n        Ajax.call([{\n            methodname: 'block_sharing_cart_restore_item_from_sharing_cart_into_section',\n            args: {\n                item_id: item.getItemId(),\n                section_id: sectionId,\n                course_modules_to_include: courseModuleIds,\n            },\n            done: async (success) => {\n                if (success) {\n                    await this.#queue.loadQueue(true);\n                }\n            },\n            fail: (data) => {\n                console.error(data);\n            }\n        }]);\n    }\n\n    /**\n     * @param {ItemElement} item\n     * @param {Number} sectionId\n     * @param {Event} e\n     */\n    async confirmImportBackupFromSharingCart(item, sectionId, e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const strings = await get_strings([\n            {\n                key: 'copy_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'into_section',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'import',\n                component: 'core',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const sectionName = this.#course.getSectionName(sectionId);\n\n        const {html, js} = await this.#baseFactory.moodle().template().renderFragment(\n            'block_sharing_cart',\n            'item_restore_form',\n            1,\n            {\n                item_id: item.getItemId()\n            }\n        );\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0] + ': ' +\n                '\"' + item.getItemName().slice(0, 50).trim() + '\"' +\n                strings[1] + ': ' +\n                '\"' + sectionName.slice(0, 50).trim() + '\"',\n            body: html,\n            buttons: {\n                save: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n        modal.getRoot().on(ModalEvents.shown, () => this.#baseFactory.moodle().template().runTemplateJS(js));\n        modal.getRoot().on(ModalEvents.save, this.importItem.bind(this, item, sectionId, modal.getRoot()[0]));\n        await modal.show();\n    }\n}"],"names":["constructor","baseFactory","element","canBackupUserdata","canAnonymizeUserdata","addEventListeners","setupCourse","setupQueue","setupItems","course","document","querySelector","courseElement","_classPrivateFieldGet","block","this","addBackupToSharingCartButtons","queue","querySelectorAll","forEach","setupItem","itemElement","item","remove","push","setClipboard","clearClipboard","deleteItem","call","methodname","args","item_id","getItemId","done","async","deleted","getItemChildrenRecursively","childItem","index","findIndex","i","Number","parseInt","dataset","itemid","_classPrivateFieldGet3","splice","_classPrivateFieldGet4","length","innerHTML","console","error","fail","data","itemName","onSave","strings","key","component","html","js","moodle","template","renderTemplate","show_user_data_backup","show_anonymize_user_data","modal","ModalFactory","create","type","types","SAVE_CANCEL","title","slice","trim","body","buttons","save","cancel","removeOnClose","getRoot","on","ModalEvents","shown","runTemplateJS","modalUserdataCheckbox","getElementById","modalAnonymizeCheckbox","users","checked","anonymize","sectionId","sectionName","getSectionName","createBackupItemToSharingCartModal","settings","section_id","renderItem","show","courseModuleId","courseModuleName","getCourseModuleName","course_module_id","existingItemIndex","id","existingItem","oldElement","createElementFromFragment","replaceChild","subItem","createElementFromTemplate","name","status","status_awaiting","has_run_now","task_id","status_finished","status_failed","is_module","is_section","is_root","append","importItem","courseModuleIds","checkbox","isSection","setCustomValidity","reportValidity","course_modules_to_include","success","loadQueue","e","preventDefault","stopPropagation","renderFragment","getItemName","bind"],"mappings":"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"}