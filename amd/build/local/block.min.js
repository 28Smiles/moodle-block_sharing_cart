define("block_sharing_cart/local/block",["exports","core/reactive","core/str","core_courseformat/courseeditor","../app/factory"],(function(_exports,_reactive,_str,_courseeditor,_factory){var obj;function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_factory=(obj=_factory)&&obj.__esModule?obj:{default:obj};class Block extends _reactive.BaseComponent{constructor(){super(...arguments),_defineProperty(this,"course",void 0),_defineProperty(this,"block",void 0),_defineProperty(this,"queue",void 0)}create(descriptor){var _descriptor$canBackup,_descriptor$canAnonym,_descriptor$showShari;this.name="sharing_cart_block",this.selectors={},this.canBackupUserdata=null!==(_descriptor$canBackup=descriptor.canBackupUserdata)&&void 0!==_descriptor$canBackup&&_descriptor$canBackup,this.canAnonymizeUserdata=null!==(_descriptor$canAnonym=descriptor.canAnonymizeUserdata)&&void 0!==_descriptor$canAnonym&&_descriptor$canAnonym,this.showSharingCartBasket=null!==(_descriptor$showShari=descriptor.showSharingCartBasket)&&void 0!==_descriptor$showShari&&_descriptor$showShari}static init(target,canBackupUserdata,canAnonymizeUserdata,showSharingCartBasket){return new this({element:document.getElementById(target),reactive:(0,_courseeditor.getCurrentCourseEditor)(),canBackupUserdata:canBackupUserdata,canAnonymizeUserdata:canAnonymizeUserdata,showSharingCartBasket:showSharingCartBasket})}stateReady(){this.baseFactory=_factory.default.make();const{course:course,block:block,queue:queue}=this.baseFactory.block().eventHandler().onLoad(this.canBackupUserdata,this.canAnonymizeUserdata,this.showSharingCartBasket);this.course=course,this.block=block,this.queue=queue;const courseContent=document.querySelector(".course-content");if(courseContent){courseContent.querySelectorAll('[data-for="section"]').forEach((sectionElement=>{const section=this.reactive.state.section.get(sectionElement.dataset.id);this._refreshSection({element:section})}));courseContent.querySelectorAll('[data-for="cmitem"]').forEach((courseModuleElement=>{const courseModule=this.reactive.state.cm.get(courseModuleElement.dataset.id);this._refreshCourseModule({element:courseModule})}))}}getWatchers(){return[{watch:"section:created",handler:this._refreshSection},{watch:"section:updated",handler:this._refreshSection},{watch:"cm:created",handler:this._refreshCourseModule},{watch:"cm:updated",handler:this._refreshCourseModule}]}async getBackupToSharingCartButton(){return this._sharingCartButton||(this._sharingCartButton=await this.baseFactory.moodle().template().createElementFromTemplate("block_sharing_cart/block/course/add_to_sharing_cart_button",{})),this._sharingCartButton.cloneNode(!0)}async _refreshSection(_ref){let{element:element}=_ref;if(this.showSharingCartBasket){let backupButton=await this.getBackupToSharingCartButton();const sectionTitle=document.querySelector('.course-content .course-section-header .inplaceeditable[data-itemid="'+element.id+'"]');if(sectionTitle){sectionTitle.parentElement.querySelector(".add_to_sharing_cart")||(sectionTitle.after(backupButton),backupButton.addEventListener("click",(e=>{e.currentTarget.classList.contains("disabled")||this.block.addSectionBackupToSharingCart(element.id)}))),backupButton=sectionTitle.parentElement.querySelector(".add_to_sharing_cart");const disabled=0===element.cmlist.length;backupButton.classList.toggle("disabled",disabled),backupButton.title=disabled?await(0,_str.get_string)("no_course_modules_in_section_description","block_sharing_cart"):""}}}async _refreshCourseModule(_ref2){let{element:element}=_ref2;if(this.showSharingCartBasket){const backupButton=await this.getBackupToSharingCartButton(),courseModuleActionMenu=document.querySelector('.course-content .cm_action_menu[data-cmid="'+element.id+'"]');if(!courseModuleActionMenu)return void setTimeout((()=>this._refreshCourseModule({element:element})),100);courseModuleActionMenu.querySelector(".add_to_sharing_cart")||(courseModuleActionMenu.append(backupButton),backupButton.addEventListener("click",this.block.addCourseModuleBackupToSharingCart.bind(this.block,element.id)))}}}return _exports.default=Block,_exports.default}));

//# sourceMappingURL=block.min.js.map